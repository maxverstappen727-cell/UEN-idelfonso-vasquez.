<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colegio Ildefonso V√°zquez</title>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Plataforma educativa del Colegio Ildefonso V√°zquez">
    
    <!-- ESTILOS INLINE (Tailwind simplificado) -->
    <style>
        /* Todos los estilos inline que te pas√© anteriormente */
        /* ... (mant√©n todos los estilos que te di) ... */
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
    <!-- TODO EL HTML QUE YA TIENES -->
    <!-- ... -->
    
    <!-- ============================================
         ORDEN CORRECTO DE SCRIPTS - ¬°IMPORTANTE!
         ============================================ -->
    
    <!-- 1. Supabase SDK (PRIMERO) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 2. Configuraci√≥n de Supabase (SEGUNDO) -->
    <script>
        // CONFIGURACI√ìN SUPABASE - INLINE PARA ASEGURAR CARGA
        console.log('üîß Configurando Supabase INLINE...');
        
        const supabaseUrl = 'https://eixyvceoedhgpxkefnws.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpeHl2Y2VvZWRoZ3B4a2VmbndzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMTk0MjYsImV4cCI6MjA4Mjg5NTQyNn0.izyXmqCZaacTYYomJZ2oUM1uT5ysFaJGdKP2Kc1YrtY';
        
        // Verificar que Supabase est√© disponible
        if (typeof window.supabase === 'undefined') {
            console.error('‚ùå ERROR: Supabase SDK no se carg√≥');
            document.write('<p style="color:red;padding:20px;">Error: Supabase no se carg√≥. Recarga la p√°gina.</p>');
        } else {
            console.log('‚úÖ Supabase SDK disponible');
            
            // Crear cliente
            const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            
            // Verificar conexi√≥n
            supabaseClient.auth.getSession().then(({ data, error }) => {
                if (error) {
                    console.error('‚ùå Error en conexi√≥n Supabase:', error.message);
                } else {
                    console.log('‚úÖ Supabase conectado correctamente');
                    console.log('üìä URL:', supabaseUrl);
                    console.log('üîë Key:', supabaseAnonKey.substring(0, 20) + '...');
                }
            });
            
            // Exportar GLOBALMENTE
            window.supabaseClient = supabaseClient;
            console.log('‚úÖ window.supabaseClient definido');
        }
    </script>
    
    <!-- 3. Storage Manager (TERCERO) -->
    <script>
        // STORAGE MANAGER (ImgBB) - INLINE
        class StorageManager {
            constructor() {
                this.apiKey = 'c55c6a2ccb0bc61795de75942c0e087e';
            }

            async uploadImage(file, folder = 'publications') {
                try {
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Solo se permiten archivos de imagen');
                    }
                    
                    const formData = new FormData();
                    formData.append('image', file);

                    console.log("Subiendo imagen a ImgBB...");

                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${this.apiKey}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log("‚úÖ Foto subida con √©xito:", result.data.url);
                        
                        return {
                            url: result.data.url,
                            path: result.data.id,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            delete_url: result.data.delete_url
                        };
                    } else {
                        throw new Error(result.error.message);
                    }
                    
                } catch (error) {
                    console.error("‚ùå Error en StorageManager:", error);
                    alert("Error al subir la imagen: " + error.message);
                    throw error;
                }
            }

            async deleteImage(imageUrl) {
                console.warn("La eliminaci√≥n autom√°tica no est√° disponible en ImgBB gratuito");
                return { success: true };
            }

            getOptimizedImageUrl(originalUrl) {
                return originalUrl;
            }

            createLocalPreview(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
            }
        }

        // Inicializar globalmente
        window.storageManager = new StorageManager();
        console.log('‚úÖ storageManager inicializado');
    </script>
    
    <!-- 4. Database Manager (CUARTO) -->
    <script>
        // DATABASE MANAGER - INLINE
        class DatabaseManager {
            constructor() {
                console.log('üöÄ DatabaseManager inicializado');
                this.cacheDuration = 30000; // 30 segundos de cache
                this.cache = {
                    subjects: { data: null, timestamp: 0 },
                    publications: { data: null, timestamp: 0 }
                };
                
                // Verificar inmediatamente si supabaseClient existe
                setTimeout(() => this.checkInitialization(), 100);
            }
            
            checkInitialization() {
                console.log('üîç Verificando inicializaci√≥n...');
                console.log('supabaseClient disponible?', typeof window.supabaseClient !== 'undefined');
                console.log('supabase disponible?', typeof window.supabase !== 'undefined');
                
                if (!window.supabaseClient) {
                    console.warn('‚ö†Ô∏è supabaseClient no disponible. Reintentando en 1 segundo...');
                    setTimeout(() => this.checkInitialization(), 1000);
                } else {
                    console.log('‚úÖ DatabaseManager completamente inicializado');
                }
            }

            checkSupabase() {
                if (!window.supabaseClient) {
                    console.error('‚ùå ERROR: supabaseClient no est√° definido');
                    console.log('‚ÑπÔ∏è Estado actual:', {
                        supabase: typeof window.supabase,
                        supabaseClient: typeof window.supabaseClient,
                        storageManager: typeof window.storageManager
                    });
                    return false;
                }
                return true;
            }

            async getSubjects(forceRefresh = false) {
                // Verificar Supabase primero
                if (!this.checkSupabase()) {
                    console.log('üîÑ Reintentando obtener materias en 500ms...');
                    return new Promise(resolve => {
                        setTimeout(async () => {
                            const data = await this.getSubjects(forceRefresh);
                            resolve(data);
                        }, 500);
                    });
                }

                // Verificar cache
                const now = Date.now();
                if (!forceRefresh && this.cache.subjects.data && 
                    (now - this.cache.subjects.timestamp) < this.cacheDuration) {
                    console.log('üìö Materias desde cach√©');
                    return this.cache.subjects.data;
                }

                try {
                    console.log('üîç Obteniendo materias desde Supabase...');
                    const { data, error } = await window.supabaseClient
                        .from('subjects')
                        .select('*')
                        .order('order', { ascending: true });
                    
                    if (error) {
                        console.error('‚ùå Error obteniendo materias:', error.message);
                        return [];
                    }
                    
                    console.log(`‚úÖ ${data.length} materias obtenidas`);
                    this.cache.subjects = { data, timestamp: now };
                    return data;
                    
                } catch (error) {
                    console.error('‚ùå Excepci√≥n en getSubjects:', error);
                    return [];
                }
            }

            async getPublications(limit = null, forceRefresh = false) {
                // Verificar Supabase primero
                if (!this.checkSupabase()) {
                    console.log('üîÑ Reintentando obtener publicaciones en 500ms...');
                    return new Promise(resolve => {
                        setTimeout(async () => {
                            const data = await this.getPublications(limit, forceRefresh);
                            resolve(data);
                        }, 500);
                    });
                }

                // Verificar cache
                const now = Date.now();
                if (!forceRefresh && this.cache.publications.data && 
                    (now - this.cache.publications.timestamp) < this.cacheDuration) {
                    console.log('üì∞ Publicaciones desde cach√©');
                    let data = this.cache.publications.data;
                    if (limit && data.length > limit) {
                        return data.slice(0, limit);
                    }
                    return data;
                }

                try {
                    console.log('üì∞ Obteniendo publicaciones desde Supabase...');
                    let query = window.supabaseClient
                        .from('publicaciones')
                        .select('*')
                        .order('fecha', { ascending: false });
                    
                    if (limit) {
                        query = query.limit(limit);
                        console.log(`üîç Limitando a ${limit} publicaciones`);
                    }
                    
                    const { data, error } = await query;
                    
                    if (error) {
                        console.error('‚ùå Error obteniendo publicaciones:', error.message);
                        return [];
                    }
                    
                    console.log(`‚úÖ ${data.length} publicaciones obtenidas`);
                    this.cache.publications = { data, timestamp: now };
                    return data;
                    
                } catch (error) {
                    console.error('‚ùå Excepci√≥n en getPublications:', error);
                    return [];
                }
            }

            async addPublication(publication) {
                try {
                    if (!this.checkSupabase()) {
                        return { success: false, error: 'Supabase no inicializado' };
                    }
                    
                    console.log('‚ûï Agregando nueva publicaci√≥n:', publication.title);
                    
                    const { data, error } = await window.supabaseClient
                        .from('publicaciones')
                        .insert([{
                            titulo: publication.title,
                            descripcion: publication.content,
                            url_imagen: publication.imageUrl || '',
                            fecha: new Date().toISOString(),
                            autor: 'Administrador',
                            likes: 0
                        }])
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Error insertando publicaci√≥n:', error);
                        return { success: false, error: error.message };
                    }
                    
                    console.log('‚úÖ Publicaci√≥n agregada exitosamente');
                    
                    // Invalidar cache
                    this.cache.publications = { data: null, timestamp: 0 };
                    
                    return { success: true, data: data[0] };
                    
                } catch (error) {
                    console.error('‚ùå Excepci√≥n en addPublication:', error);
                    return { success: false, error: error.message };
                }
            }

            async deletePublication(id) {
                try {
                    if (!this.checkSupabase()) {
                        return { success: false, error: 'Supabase no inicializado' };
                    }
                    
                    console.log(`üóëÔ∏è Eliminando publicaci√≥n ID: ${id}`);
                    
                    const { error } = await window.supabaseClient
                        .from('publicaciones')
                        .delete()
                        .eq('id', id);
                    
                    if (error) {
                        console.error('‚ùå Error eliminando publicaci√≥n:', error);
                        return { success: false, error: error.message };
                    }
                    
                    console.log('‚úÖ Publicaci√≥n eliminada');
                    
                    // Invalidar cache
                    this.cache.publications = { data: null, timestamp: 0 };
                    
                    return { success: true };
                    
                } catch (error) {
                    console.error('‚ùå Excepci√≥n en deletePublication:', error);
                    return { success: false, error: error.message };
                }
            }

            async getStats() {
                try {
                    const [subjects, publications] = await Promise.all([
                        this.getSubjects(),
                        this.getPublications()
                    ]);
                    
                    return {
                        totalSubjects: subjects.length,
                        totalPublications: publications.length,
                        totalResources: 0,
                        lastUpdate: new Date().toLocaleTimeString()
                    };
                } catch (error) {
                    console.error('‚ùå Error obteniendo estad√≠sticas:', error);
                    return { totalSubjects: 0, totalPublications: 0, totalResources: 0 };
                }
            }

            async getSchoolInfo() {
                return { 
                    nombre: "Colegio Ildefonso V√°zquez",
                    lema: "Con fe hacia lo alto",
                    a√±o: "2025",
                    director: "Mar√≠a Gonz√°lez",
                    telefono: "(601) 234-5678",
                    email: "info@colegioildelfonso.edu.co",
                    direccion: "Calle 123 #45-67, Bogot√°",
                    fundacion: "1975"
                };
            }
        }

        // Inicializar globalmente
        window.dbManager = new DatabaseManager();
        console.log('‚úÖ DatabaseManager listo para usar');
    </script>
    
    <!-- 5. App.js - C√≥digo de la aplicaci√≥n (QUINTO) -->
    <script>
        // APP.JS - INLINE
        class ColegioApp {
            constructor() {
                console.log('üè´ ColegioApp inicializando...');
                this.currentView = 'home';
                this.activeSubject = null;
                this.init();
            }

            async init() {
                console.log('üîß Inicializando aplicaci√≥n...');
                this.loadIcons();
                this.setupEventListeners();
                this.initThemes();
                this.checkAuth();
                
                // Esperar un momento para que todo cargue
                setTimeout(() => {
                    this.loadInitialData();
                }, 1000);
            }

            loadIcons() {
                if (window.lucide && window.lucide.createIcons) {
                    lucide.createIcons();
                    console.log('‚úÖ Iconos cargados');
                } else {
                    console.warn('‚ö†Ô∏è Lucide no disponible');
                }
            }

            setupEventListeners() {
                // Men√∫ m√≥vil
                const mobileBtn = document.getElementById('mobile-menu-btn');
                if (mobileBtn) {
                    mobileBtn.addEventListener('click', () => {
                        document.getElementById('mobile-menu').classList.toggle('hidden');
                    });
                }
                
                // Cerrar men√∫ al hacer clic fuera
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('mobile-menu');
                    const btn = document.getElementById('mobile-menu-btn');
                    if (menu && !menu.contains(e.target) && btn && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
            }

            initThemes() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark');
                    const icon = document.getElementById('theme-icon');
                    if (icon) icon.setAttribute('data-lucide', 'moon');
                }
            }

            checkAuth() {
                const isAdmin = localStorage.getItem('isAdmin') === 'true';
                console.log('üîê Estado de autenticaci√≥n:', isAdmin ? 'Admin' : 'Usuario');
                
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(el => {
                    el.classList.toggle('hidden', !isAdmin);
                });
            }

            async loadInitialData() {
                console.log('üì• Cargando datos iniciales...');
                
                // Mostrar loading
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.classList.remove('hidden');
                
                try {
                    // Verificar que dbManager est√© listo
                    if (!window.dbManager) {
                        console.error('‚ùå dbManager no disponible');
                        return;
                    }
                    
                    console.log('‚úÖ dbManager disponible, cargando datos...');
                    
                    const [subjects, publications, schoolInfo] = await Promise.all([
                        window.dbManager.getSubjects(),
                        window.dbManager.getPublications(3),
                        window.dbManager.getSchoolInfo()
                    ]);
                    
                    console.log('üìä Datos cargados:', {
                        subjects: subjects.length,
                        publications: publications.length
                    });
                    
                    this.updateStats();
                    this.renderPreviewPublications(publications);
                    this.renderSubjectsGrid(subjects);
                    this.updateSchoolInfo(schoolInfo);
                    
                } catch (error) {
                    console.error("‚ùå Error cargando datos iniciales:", error);
                    this.showError("Error cargando datos. Intenta recargar la p√°gina.");
                } finally {
                    // Ocultar loading
                    if (loadingEl) loadingEl.classList.add('hidden');
                }
            }

            async updateStats() {
                try {
                    if (!window.dbManager) {
                        console.error('‚ùå dbManager no disponible para stats');
                        return;
                    }
                    
                    const stats = await window.dbManager.getStats();
                    console.log('üìà Estad√≠sticas:', stats);
                    
                    const totalSubjects = document.getElementById('total-subjects');
                    const totalPublications = document.getElementById('total-publications');
                    const totalResources = document.getElementById('total-resources');
                    
                    if (totalSubjects) totalSubjects.textContent = stats.totalSubjects;
                    if (totalPublications) totalPublications.textContent = stats.totalPublications;
                    if (totalResources) totalResources.textContent = stats.totalResources;
                    
                } catch (error) {
                    console.error("‚ùå Error cargando estad√≠sticas:", error);
                }
            }

            renderPreviewPublications(publications) {
                const container = document.getElementById('preview-publications');
                if (!container) {
                    console.error('‚ùå Container preview-publications no encontrado');
                    return;
                }
                
                if (!publications || publications.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl">
                            <i data-lucide="newspaper" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-400">No hay publicaciones recientes</p>
                        </div>
                    `;
                    this.loadIcons();
                    return;
                }
                
                container.innerHTML = publications.map(pub => `
                    <div class="card p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="app.showView('publications')">
                        <div class="flex items-start justify-between mb-3">
                            <h4 class="font-bold text-gray-800 dark:text-white line-clamp-2 flex-1">${pub.titulo}</h4>
                            <span class="text-xs text-gray-500 dark:text-gray-400 ml-2 whitespace-nowrap">${this.formatDate(pub.fecha)}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-3 mb-4">${pub.descripcion}</p>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-500 dark:text-gray-400">${pub.autor || 'Colegio'}</span>
                            <div class="flex items-center space-x-3">
                                <span class="flex items-center text-gray-500 dark:text-gray-400">
                                    <i data-lucide="heart" class="w-3 h-3 mr-1 text-red-500"></i>
                                    ${pub.likes || 0}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                this.loadIcons();
            }

            renderSubjectsGrid(subjects) {
                const container = document.getElementById('subjects-grid');
                if (!container) return;
                
                if (!subjects || subjects.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl">
                            <i data-lucide="book-open" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-2">No hay materias</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">A√∫n no se han agregado materias.</p>
                        </div>
                    `;
                    this.loadIcons();
                    return;
                }
                
                container.innerHTML = subjects.slice(0, 4).map(subject => {
                    const colorClass = subject.color || 'bg-blue-600';
                    const icon = subject.icon || 'üìö';
                    
                    return `
                    <div class="card p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="app.showSubjectResources('${subject.id}')">
                        <div class="${colorClass} w-16 h-16 rounded-xl flex items-center justify-center text-3xl mb-4">
                            ${icon}
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">${subject.name}</h3>
                        ${subject.grade ? `<p class="text-gray-600 dark:text-gray-300 mb-4">${subject.grade}</p>` : ''}
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500 dark:text-gray-400">
                                Ver recursos ‚Üí
                            </span>
                        </div>
                    </div>
                    `;
                }).join('');
                
                this.loadIcons();
            }

            formatDate(dateString) {
                if (!dateString) return 'Fecha no disponible';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (error) {
                    return 'Fecha inv√°lida';
                }
            }

            async showView(viewName, params = {}) {
                console.log('üîÑ Cambiando a vista:', viewName);
                
                // Ocultar todas las vistas
                document.querySelectorAll('.view').forEach(view => {
                    view.classList.add('hidden');
                });
                
                // Actualizar navegaci√≥n
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.view === viewName) {
                        link.classList.add('active');
                    }
                });
                
                // Cerrar men√∫ m√≥vil
                document.getElementById('mobile-menu')?.classList.add('hidden');
                
                // Mostrar vista seleccionada
                const viewElement = document.getElementById(`${viewName}-view`);
                if (viewElement) {
                    viewElement.classList.remove('hidden');
                }
                
                // Cargar datos espec√≠ficos de la vista
                if (viewName === 'admin') {
                    await this.loadAdminView();
                } else if (viewName === 'publications') {
                    await this.loadAllPublications();
                } else if (viewName === 'subjects') {
                    await this.loadAllSubjects();
                }
            }

            async loadAllPublications() {
                try {
                    if (!window.dbManager) {
                        console.error('‚ùå dbManager no disponible');
                        return;
                    }
                    
                    const publications = await window.dbManager.getPublications();
                    this.renderPublicationsList(publications);
                } catch (error) {
                    console.error("‚ùå Error cargando publicaciones:", error);
                }
            }

            renderPublicationsList(publications) {
                const container = document.getElementById('publications-list');
                if (!container) return;
                
                if (!publications || publications.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl">
                            <i data-lucide="newspaper" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-2">No hay publicaciones</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">
                                A√∫n no se han publicado noticias o anuncios.
                            </p>
                        </div>
                    `;
                    this.loadIcons();
                    return;
                }
                
                container.innerHTML = publications.map(pub => `
                    <div class="card overflow-hidden hover:shadow-lg transition-shadow">
                        ${pub.url_imagen ? `
                        <div class="border-b dark:border-gray-700">
                            <img src="${pub.url_imagen}" 
                                 alt="${pub.titulo}" 
                                 class="w-full h-64 object-cover"
                                 loading="lazy">
                        </div>
                        ` : ''}
                        
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">${pub.titulo}</h3>
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                                    ${this.formatDate(pub.fecha)}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 mb-4 text-sm">
                                <div class="flex items-center">
                                    <i data-lucide="user" class="w-4 h-4 mr-1 text-gray-400"></i>
                                    <span class="text-gray-600 dark:text-gray-300">${pub.autor || 'Colegio'}</span>
                                </div>
                            </div>
                            
                            <p class="text-gray-700 dark:text-gray-300 mb-6 whitespace-pre-line">${pub.descripcion}</p>
                        </div>
                    </div>
                `).join('');
                
                this.loadIcons();
            }

            async loadAllSubjects() {
                try {
                    if (!window.dbManager) {
                        console.error('‚ùå dbManager no disponible');
                        return;
                    }
                    
                    const subjects = await window.dbManager.getSubjects();
                    this.renderAllSubjects(subjects);
                } catch (error) {
                    console.error("‚ùå Error cargando materias:", error);
                }
            }

            renderAllSubjects(subjects) {
                const container = document.getElementById('subjects-grid-full');
                if (!container) return;
                
                if (!subjects || subjects.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-xl">
                            <i data-lucide="book-open" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-700 dark:text-white mb-2">No hay materias</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">A√∫n no se han agregado materias.</p>
                        </div>
                    `;
                    this.loadIcons();
                    return;
                }
                
                container.innerHTML = subjects.map(subject => {
                    const colorClass = subject.color || 'bg-blue-600';
                    const icon = subject.icon || 'üìö';
                    
                    return `
                    <div class="card p-6 text-center hover:shadow-lg">
                        <div class="${colorClass} w-16 h-16 rounded-xl flex items-center justify-center text-3xl mb-4 mx-auto">
                            ${icon}
                        </div>
                        <h3 class="font-bold text-lg mb-2">${subject.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">${subject.grade || 'Todos los grados'}</p>
                        <button onclick="app.showResources('${subject.id}')" class="btn-secondary text-sm">
                            Ver Recursos
                        </button>
                    </div>
                    `;
                }).join('');
                
                this.loadIcons();
            }

            async loadAdminView() {
                const isAdmin = localStorage.getItem('isAdmin') === 'true';
                if (!isAdmin) {
                    this.showView('home');
                    this.showError("Acceso denegado");
                    return;
                }
                
                await this.showAdminTab('dashboard');
            }

            async showAdminTab(tabName) {
                console.log('üìã Cambiando a tab admin:', tabName);
                
                // Ocultar todos los contenidos
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Actualizar pesta√±as activas
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    if (tab.textContent.toLowerCase().includes(tabName)) {
                        tab.classList.add('active', 'border-blue-500', 'text-blue-600');
                    }
                });
                
                // Mostrar contenido seleccionado
                const contentId = `admin-${tabName}`;
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.remove('hidden');
                    
                    // Cargar datos espec√≠ficos del tab
                    switch(tabName) {
                        case 'dashboard':
                            await this.loadAdminDashboard();
                            break;
                        case 'publications':
                            await this.loadAdminPublications();
                            break;
                        case 'subjects':
                            await this.loadAdminSubjects();
                            break;
                    }
                }
            }

            async loadAdminDashboard() {
                try {
                    if (!window.dbManager) {
                        console.error('‚ùå dbManager no disponible para dashboard');
                        return;
                    }
                    
                    const stats = await window.dbManager.getStats();
                    
                    // Actualizar estad√≠sticas
                    const adminSubjects = document.getElementById('admin-total-subjects');
                    const adminPublications = document.getElementById('admin-total-publications');
                    
                    if (adminSubjects) adminSubjects.textContent = stats.totalSubjects;
                    if (adminPublications) adminPublications.textContent = stats.totalPublications;
                    
                    // Cargar datos recientes
                    await Promise.all([
                        this.loadAdminRecentPublications(),
                        this.loadAdminRecentResources()
                    ]);
                    
                } catch (error) {
                    console.error("‚ùå Error cargando dashboard admin:", error);
                }
            }

            async loadAdminRecentPublications() {
                try {
                    if (!window.dbManager) return;
                    
                    const publications = await window.dbManager.getPublications(5);
                    const container = document.getElementById('admin-recent-publications');
                    
                    if (!container) return;
                    
                    container.innerHTML = publications.map(pub => `
                        <div class="border-b dark:border-gray-700 pb-4 last:border-0 last:pb-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold line-clamp-1 dark:text-white">${pub.titulo}</h4>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${this.formatDate(pub.fecha)}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 mt-1">${pub.descripcion}</p>
                            <div class="flex items-center justify-between mt-2 text-xs">
                                <span class="text-gray-500 dark:text-gray-400">${pub.autor || 'Colegio'}</span>
                                <div class="flex items-center space-x-2">
                                    <button onclick="app.deletePublication('${pub.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800">
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error("‚ùå Error cargando publicaciones recientes:", error);
                }
            }

            async loadAdminRecentResources() {
                const container = document.getElementById('admin-recent-resources');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="file-text" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-gray-500 dark:text-gray-400">Sin actividad reciente</p>
                        </div>
                    `;
                    this.loadIcons();
                }
            }

            async loadAdminPublications() {
                try {
                    if (!window.dbManager) return;
                    
                    const publications = await window.dbManager.getPublications();
                    const container = document.getElementById('admin-publications-list');
                    
                    if (!container) return;
                    
                    container.innerHTML = publications.map(pub => `
                        <div class="border-b dark:border-gray-700 pb-4 last:border-0 last:pb-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold">${pub.titulo}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${pub.descripcion}</p>
                                </div>
                                <button onclick="app.deletePublication('${pub.id}')" class="text-red-600 hover:text-red-800 ml-4">
                                    <i data-lucide="trash" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${this.formatDate(pub.fecha)} ‚Ä¢ ${pub.autor || 'Colegio'}
                            </div>
                        </div>
                    `).join('');
                    
                    this.loadIcons();
                    
                } catch (error) {
                    console.error("‚ùå Error cargando publicaciones admin:", error);
                }
            }

            async loadAdminSubjects() {
                const container = document.getElementById('admin-subjects-list');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="book-open" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-gray-500 dark:text-gray-400">Gesti√≥n de materias pr√≥ximamente</p>
                        </div>
                    `;
                    this.loadIcons();
                }
            }

            async deletePublication(id) {
                if (!confirm("¬øEst√°s seguro de eliminar esta publicaci√≥n?")) return;
                
                try {
                    if (!window.dbManager) {
                        this.showError("Error: DatabaseManager no disponible");
                        return;
                    }
                    
                    const result = await window.dbManager.deletePublication(id);
                    if (result.success) {
                        this.showSuccess("Publicaci√≥n eliminada");
                        // Recargar las vistas afectadas
                        await Promise.all([
                            this.loadAdminPublications(),
                            this.loadAdminDashboard(),
                            this.loadAllPublications()
                        ]);
                    } else {
                        this.showError("Error: " + result.error);
                    }
                } catch (error) {
                    this.showError("Error eliminando publicaci√≥n");
                }
            }

            showSubjectResources(subjectId) {
                alert(`Recursos de la materia ${subjectId} - Pr√≥ximamente`);
            }

            showResources(subjectId) {
                alert(`Recursos de la materia ${subjectId} - Pr√≥ximamente`);
            }

            showError(message) {
                console.error("‚ùå Error:", message);
                alert("‚ùå " + message);
            }

            showSuccess(message) {
                console.log("‚úÖ √âxito:", message);
                alert("‚úÖ " + message);
            }

            updateSchoolInfo(info = null) {
                // Implementar si es necesario
            }
        }

        // ============================================
        // INICIALIZACI√ìN Y EVENTOS GLOBALES
        // ============================================
        
        // Funciones globales
        function showLoginModal() { 
            document.getElementById('login-modal').classList.remove('hidden'); 
            document.getElementById('login-email').focus();
        }
        
        function hideLoginModal() { 
            document.getElementById('login-modal').classList.add('hidden'); 
        }
        
        // Login handler
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if(email === "admin@colegio.edu" && password === "colegio2025") {
                localStorage.setItem('isAdmin', 'true');
                hideLoginModal();
                
                // Actualizar UI
                document.getElementById('admin-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                
                // Recargar estado de admin
                if (window.app) {
                    window.app.checkAuth();
                    window.app.showView('admin');
                }
                
                alert('‚úÖ ¬°Bienvenido Administrador!');
            } else {
                alert('‚ùå Credenciales incorrectas. Usa: admin@colegio.edu / colegio2025');
            }
        });
        
        // Logout handler
        window.authManager = {
            logout: function() {
                localStorage.removeItem('isAdmin');
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                
                if (window.app) {
                    window.app.checkAuth();
                    window.app.showView('home');
                }
                alert('‚úÖ Sesi√≥n cerrada correctamente');
            }
        };
        
        // Formulario de publicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const pubForm = document.getElementById('publication-form');
            if (pubForm) {
                pubForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const title = document.getElementById('pub-title').value;
                    const content = document.getElementById('pub-content').value;
                    const imageFile = document.getElementById('pub-image').files[0];
                    
                    if (!title || !content) {
                        alert('‚ùå Por favor completa t√≠tulo y contenido');
                        return;
                    }
                    
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>Publicando...';
                    
                    let imageUrl = '';
                    if (imageFile) {
                        try {
                            console.log('üì§ Subiendo imagen...');
                            const uploadResult = await window.storageManager.uploadImage(imageFile);
                            imageUrl = uploadResult.url;
                            console.log('‚úÖ Imagen subida:', imageUrl);
                        } catch (error) {
                            alert('‚ùå Error subiendo imagen: ' + error.message);
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            return;
                        }
                    }
                    
                    try {
                        const result = await window.dbManager.addPublication({
                            title: title,
                            content: content,
                            imageUrl: imageUrl
                        });
                        
                        if (result.success) {
                            alert('‚úÖ Publicaci√≥n creada con √©xito');
                            this.reset();
                            
                            // Recargar datos
                            if (window.app) {
                                await Promise.all([
                                    window.app.loadAdminPublications(),
                                    window.app.loadAdminDashboard(),
                                    window.app.loadInitialData()
                                ]);
                            }
                        } else {
                            alert('‚ùå Error: ' + result.error);
                        }
                    } catch (error) {
                        alert('‚ùå Error inesperado: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        if (window.lucide) lucide.createIcons();
                    }
                });
            }
        });

        // Inicializar aplicaci√≥n cuando todo est√© listo
        window.addEventListener('load', function() {
            console.log('üöÄ Inicializando aplicaci√≥n completa...');
            
            // Inicializar Lucide icons
            if (window.lucide && window.lucide.createIcons) {
                lucide.createIcons();
            }
            
            // Inicializar tema
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                const icon = document.getElementById('theme-icon');
                if (icon) icon.setAttribute('data-lucide', 'moon');
            }
            
            // Crear instancia de la app
            window.app = new ColegioApp();
            console.log('‚úÖ Aplicaci√≥n inicializada');
            
            // Verificar estado despu√©s de 2 segundos
            setTimeout(() => {
                console.log('üîç Estado final:', {
                    supabaseClient: typeof window.supabaseClient,
                    dbManager: typeof window.dbManager,
                    storageManager: typeof window.storageManager,
                    app: typeof window.app
                });
            }, 2000);
        });
    </script>
</body>
</html>
